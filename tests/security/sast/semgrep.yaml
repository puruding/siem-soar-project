# Semgrep rules for SIEM/SOAR Platform Security Analysis
# These rules detect common security vulnerabilities in Go and Python code

rules:
  # ============================================================
  # Go Security Rules
  # ============================================================

  - id: go-sql-injection
    languages: [go]
    message: "Potential SQL injection vulnerability. Use parameterized queries instead."
    severity: ERROR
    patterns:
      - pattern-either:
          - pattern: |
              $DB.Query($QUERY + $VAR)
          - pattern: |
              $DB.Exec($QUERY + $VAR)
          - pattern: |
              $DB.QueryRow($QUERY + $VAR)
          - pattern: |
              fmt.Sprintf($QUERY, ...)
              ...
              $DB.Query($RESULT)
    metadata:
      category: security
      cwe: "CWE-89"
      owasp: "A03:2021 - Injection"
      confidence: HIGH

  - id: go-command-injection
    languages: [go]
    message: "Potential command injection vulnerability. Avoid using user input in exec commands."
    severity: ERROR
    patterns:
      - pattern-either:
          - pattern: exec.Command($CMD, $USER_INPUT, ...)
          - pattern: exec.CommandContext($CTX, $CMD, $USER_INPUT, ...)
    metadata:
      category: security
      cwe: "CWE-78"
      owasp: "A03:2021 - Injection"
      confidence: HIGH

  - id: go-path-traversal
    languages: [go]
    message: "Potential path traversal vulnerability. Validate and sanitize file paths."
    severity: ERROR
    patterns:
      - pattern-either:
          - pattern: os.Open($USER_INPUT)
          - pattern: os.ReadFile($USER_INPUT)
          - pattern: ioutil.ReadFile($USER_INPUT)
          - pattern: filepath.Join(..., $USER_INPUT)
    metadata:
      category: security
      cwe: "CWE-22"
      owasp: "A01:2021 - Broken Access Control"
      confidence: MEDIUM

  - id: go-hardcoded-credentials
    languages: [go]
    message: "Hardcoded credentials detected. Use environment variables or secrets management."
    severity: ERROR
    patterns:
      - pattern-either:
          - pattern: |
              $VAR = "password=..."
          - pattern: |
              $VAR = "api_key=..."
          - pattern: |
              $VAR = "secret=..."
          - pattern: |
              password := "..."
    metadata:
      category: security
      cwe: "CWE-798"
      owasp: "A07:2021 - Identification and Authentication Failures"
      confidence: HIGH

  - id: go-insecure-tls
    languages: [go]
    message: "Insecure TLS configuration. Do not skip certificate verification in production."
    severity: ERROR
    pattern: |
      &tls.Config{
        ...
        InsecureSkipVerify: true,
        ...
      }
    metadata:
      category: security
      cwe: "CWE-295"
      owasp: "A02:2021 - Cryptographic Failures"
      confidence: HIGH

  - id: go-weak-crypto
    languages: [go]
    message: "Weak cryptographic algorithm detected. Use stronger algorithms."
    severity: WARNING
    patterns:
      - pattern-either:
          - pattern: crypto/md5
          - pattern: crypto/sha1
          - pattern: crypto/des
    metadata:
      category: security
      cwe: "CWE-327"
      owasp: "A02:2021 - Cryptographic Failures"
      confidence: HIGH

  - id: go-unsafe-reflection
    languages: [go]
    message: "Unsafe use of reflection with user input."
    severity: WARNING
    pattern: reflect.ValueOf($USER_INPUT)
    metadata:
      category: security
      cwe: "CWE-470"
      confidence: MEDIUM

  # ============================================================
  # Python Security Rules
  # ============================================================

  - id: python-sql-injection
    languages: [python]
    message: "Potential SQL injection vulnerability. Use parameterized queries."
    severity: ERROR
    patterns:
      - pattern-either:
          - pattern: |
              cursor.execute($QUERY % $VAR)
          - pattern: |
              cursor.execute($QUERY.format(...))
          - pattern: |
              cursor.execute(f"...")
          - pattern: |
              $DB.execute($QUERY + $VAR)
    metadata:
      category: security
      cwe: "CWE-89"
      owasp: "A03:2021 - Injection"
      confidence: HIGH

  - id: python-command-injection
    languages: [python]
    message: "Potential command injection vulnerability."
    severity: ERROR
    patterns:
      - pattern-either:
          - pattern: os.system($USER_INPUT)
          - pattern: os.popen($USER_INPUT)
          - pattern: subprocess.call($USER_INPUT, shell=True)
          - pattern: subprocess.Popen($USER_INPUT, shell=True)
    metadata:
      category: security
      cwe: "CWE-78"
      owasp: "A03:2021 - Injection"
      confidence: HIGH

  - id: python-eval-injection
    languages: [python]
    message: "Dangerous use of eval() with potentially untrusted input."
    severity: ERROR
    patterns:
      - pattern-either:
          - pattern: eval($USER_INPUT)
          - pattern: exec($USER_INPUT)
    metadata:
      category: security
      cwe: "CWE-95"
      owasp: "A03:2021 - Injection"
      confidence: HIGH

  - id: python-pickle-insecure
    languages: [python]
    message: "Pickle deserialization of untrusted data is dangerous."
    severity: ERROR
    patterns:
      - pattern-either:
          - pattern: pickle.loads($USER_INPUT)
          - pattern: pickle.load($FILE)
    metadata:
      category: security
      cwe: "CWE-502"
      owasp: "A08:2021 - Software and Data Integrity Failures"
      confidence: HIGH

  - id: python-yaml-insecure
    languages: [python]
    message: "Unsafe YAML loading. Use yaml.safe_load() instead."
    severity: ERROR
    pattern: yaml.load($DATA, ...)
    fix: yaml.safe_load($DATA)
    metadata:
      category: security
      cwe: "CWE-502"
      owasp: "A08:2021 - Software and Data Integrity Failures"
      confidence: HIGH

  - id: python-hardcoded-secrets
    languages: [python]
    message: "Hardcoded secret detected. Use environment variables or secrets management."
    severity: ERROR
    patterns:
      - pattern-either:
          - pattern: |
              $VAR = "sk-..."
          - pattern: |
              API_KEY = "..."
          - pattern: |
              SECRET_KEY = "..."
          - pattern: |
              password = "..."
    metadata:
      category: security
      cwe: "CWE-798"
      owasp: "A07:2021 - Identification and Authentication Failures"
      confidence: HIGH

  - id: python-insecure-request
    languages: [python]
    message: "SSL verification disabled. This makes the connection vulnerable to MITM attacks."
    severity: ERROR
    pattern: requests.$METHOD(..., verify=False, ...)
    metadata:
      category: security
      cwe: "CWE-295"
      owasp: "A02:2021 - Cryptographic Failures"
      confidence: HIGH

  - id: python-flask-debug
    languages: [python]
    message: "Flask debug mode should not be enabled in production."
    severity: WARNING
    pattern: app.run(..., debug=True, ...)
    metadata:
      category: security
      cwe: "CWE-489"
      owasp: "A05:2021 - Security Misconfiguration"
      confidence: HIGH

  - id: python-jwt-none-algorithm
    languages: [python]
    message: "JWT with 'none' algorithm is insecure."
    severity: ERROR
    patterns:
      - pattern: jwt.decode(..., algorithms=["none"], ...)
      - pattern: jwt.decode(..., algorithms=["None"], ...)
    metadata:
      category: security
      cwe: "CWE-327"
      owasp: "A02:2021 - Cryptographic Failures"
      confidence: HIGH

  # ============================================================
  # General Security Rules
  # ============================================================

  - id: sensitive-data-logging
    languages: [go, python]
    message: "Potential logging of sensitive data. Ensure PII/credentials are not logged."
    severity: WARNING
    patterns:
      - pattern-either:
          - pattern: $LOG.Info(..., "password", ...)
          - pattern: $LOG.Debug(..., "api_key", ...)
          - pattern: $LOG.Error(..., "secret", ...)
          - pattern: logging.info(..., password=...)
          - pattern: logger.info(..., api_key=...)
    metadata:
      category: security
      cwe: "CWE-532"
      owasp: "A09:2021 - Security Logging and Monitoring Failures"
      confidence: MEDIUM

  - id: cors-allow-all
    languages: [go, python]
    message: "Overly permissive CORS configuration. Restrict allowed origins."
    severity: WARNING
    patterns:
      - pattern-either:
          - pattern: 'Access-Control-Allow-Origin: *'
          - pattern: '"Access-Control-Allow-Origin": "*"'
          - pattern: cors.AllowAll()
    metadata:
      category: security
      cwe: "CWE-942"
      owasp: "A05:2021 - Security Misconfiguration"
      confidence: HIGH

  - id: missing-rate-limiting
    languages: [go, python]
    message: "API endpoint may be missing rate limiting."
    severity: INFO
    patterns:
      - pattern-not-inside: |
          $LIMITER.Allow()
          ...
      - pattern-either:
          - pattern: http.HandleFunc(...)
          - pattern: mux.HandleFunc(...)
    metadata:
      category: security
      cwe: "CWE-770"
      owasp: "A04:2021 - Insecure Design"
      confidence: LOW
