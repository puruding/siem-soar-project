name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  GO_VERSION: "1.23"
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"
  PNPM_VERSION: "9"

jobs:
  # Determine which components changed
  changes:
    runs-on: ubuntu-latest
    outputs:
      go: ${{ steps.filter.outputs.go }}
      python: ${{ steps.filter.outputs.python }}
      web: ${{ steps.filter.outputs.web }}
      infra: ${{ steps.filter.outputs.infra }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            go:
              - 'services/**'
              - 'pkg/**'
              - 'go.work'
            python:
              - 'ai/**'
            web:
              - 'web/**'
              - 'packages/**'
              - 'package.json'
              - 'pnpm-lock.yaml'
            infra:
              - 'infra/**'

  # Go services
  go:
    needs: changes
    if: needs.changes.outputs.go == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: |
            services/*/go.sum
            pkg/*/go.sum

      - name: Install dependencies
        run: make install-go

      - name: Lint
        run: |
          go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
          make go-lint

      - name: Test
        run: make go-test

      - name: Build
        run: make go-build

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: services/*/coverage.out
          flags: go

  # Python AI services
  python:
    needs: changes
    if: needs.changes.outputs.python == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: cd ai && uv sync

      - name: Lint
        run: make py-lint

      - name: Test
        run: make py-test

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ai/coverage.xml
          flags: python

  # Web frontend
  web:
    needs: changes
    if: needs.changes.outputs.web == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Lint
        run: make web-lint

      - name: Test
        run: make web-test

      - name: Build
        run: make web-build

  # Infrastructure validation
  infra:
    needs: changes
    if: needs.changes.outputs.infra == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"

      - name: Terraform Format Check
        run: terraform fmt -check -recursive infra/terraform/

      - name: Terraform Init
        run: cd infra/terraform && terraform init -backend=false

      - name: Terraform Validate
        run: cd infra/terraform && terraform validate

  # Helm Chart Validation
  helm:
    needs: changes
    if: needs.changes.outputs.infra == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Add Helm repos
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

      - name: Lint Helm charts
        run: |
          for chart in infra/helm/*/; do
            if [ -f "$chart/Chart.yaml" ]; then
              echo "Linting $chart..."
              helm lint "$chart" --strict
            fi
          done

      - name: Template validation
        run: |
          for chart in infra/helm/*/; do
            if [ -f "$chart/Chart.yaml" ]; then
              echo "Validating template for $chart..."
              helm template test "$chart" > /dev/null
            fi
          done

  # Security scanning
  security:
    needs: changes
    if: needs.changes.outputs.go == 'true' || needs.changes.outputs.python == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (Go)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: 'services/'
          format: 'sarif'
          output: 'trivy-go-results.sarif'
          severity: 'HIGH,CRITICAL'

      - name: Run Trivy vulnerability scanner (Python)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: 'ai/'
          format: 'sarif'
          output: 'trivy-python-results.sarif'
          severity: 'HIGH,CRITICAL'

      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-go-results.sarif'
          category: 'trivy-go'

      - name: Run gosec security scanner
        if: needs.changes.outputs.go == 'true'
        uses: securego/gosec@master
        with:
          args: '-no-fail -fmt sarif -out gosec-results.sarif ./services/...'

      - name: Run bandit security scanner (Python)
        if: needs.changes.outputs.python == 'true'
        run: |
          pip install bandit
          bandit -r ai/ -f sarif -o bandit-results.sarif || true

  # Docker builds
  docker:
    needs: [go, python, web, security]
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=sha
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: Build and push images
        run: |
          VERSION=$(git describe --tags --always --dirty)
          make docker-build VERSION=$VERSION
          make docker-push VERSION=$VERSION

      - name: Run Trivy vulnerability scanner on images
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'ghcr.io/${{ github.repository }}/gateway:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-image-results.sarif'
          severity: 'HIGH,CRITICAL'

      - name: Upload Trivy image scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-image-results.sarif'
          category: 'trivy-images'

  # Integration tests (on main branch only)
  integration:
    needs: docker
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    services:
      clickhouse:
        image: clickhouse/clickhouse-server:24.1
        ports:
          - 9000:9000
          - 8123:8123
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: siem
          POSTGRES_PASSWORD: siem
          POSTGRES_DB: siem
        ports:
          - 5432:5432
      redis:
        image: redis:7
        ports:
          - 6379:6379
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Wait for services
        run: |
          for i in {1..30}; do
            nc -z localhost 9000 && nc -z localhost 5432 && nc -z localhost 6379 && break
            sleep 2
          done

      - name: Run integration tests
        env:
          CLICKHOUSE_HOST: localhost
          CLICKHOUSE_PORT: 9000
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: siem
          POSTGRES_PASSWORD: siem
          POSTGRES_DB: siem
          REDIS_HOST: localhost
          REDIS_PORT: 6379
        run: make integration-test
